<!DOCTYPE html>
<html>
  <head>
     
    <meta charset="UTF-8">
    <title>HuggingFace T5关于prune_heads方法的bug - 佛得角大海豹的博客</title>
    <link rel="shortcut icon" href="/static/img/icon.png">
    <link rel="icon" href="/static/img/icon.png" sizes="192x192"/>
    
<link rel="stylesheet" href="/static/kico.css">
<link rel="stylesheet" href="/static/hingle.css">

    
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <meta name="viewport" content="width=device-width, maximum-scale=1, initial-scale=1"/>
    <meta property="og:site_name" content="佛得角大海豹的博客">
    <meta property="og:title" content="HuggingFace T5关于prune_heads方法的bug"/>
    
    <style>body:before{ content: ''; background-image: url(https://api.paugram.com/wallpaper?source=gh) }</style>
    
<meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="佛得角大海豹的博客" type="application/atom+xml">
</head>

  <body>
    <header>
    <div class="head-title">
        <h4>佛得角大海豹的博客</h4>
    </div>
    <div class="head-action">
        <div class="toggle-btn"></div>
        <div class="light-btn"></div>
        <div class="search-btn"></div>
    </div>
    <form class="head-search" method="post">
        <input type="text" name="s" placeholder="搜索什么？">
    </form>
    <nav class="head-menu">
        <a href="/">首页</a>
        <div class="has-child">
            <a>分类</a>
            <div class="sub-menu">
                <a class="category-link" href="/categories/%E5%AD%A6%E4%B9%A0/">学习</a><a class="category-link" href="/categories/%E5%B0%8F%E8%AF%B4/">小说</a><a class="category-link" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a><a class="category-link" href="/categories/%E6%B8%B8%E6%88%8F/">游戏</a><a class="category-link" href="/categories/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/">论文阅读笔记</a><a class="category-link" href="/categories/%E8%AF%97%E6%AD%8C/">诗歌</a><a class="category-link" href="/categories/%E9%9A%8F%E7%AC%94/">随笔</a>
            </div>
        </div>
        
            <a href="/about">关于我</a>
        
    </nav>
</header>

    <main>
    <div class="wrap min">
        <section class="post-title">
            <h2>HuggingFace T5关于prune_heads方法的bug</h2>
            <div class="post-meta">
                <time class="date">2023.07.27</time>
            
                <span class="category"><a class="category-link" href="/categories/%E5%AD%A6%E4%B9%A0/">学习</a></span>
            
            </div>
        </section>
        <article class="post-content">
        
            <p>时效性：2023-07-26。<code>transformers</code>库版本：<code>4.29.0</code>
~ <code>4.31.0</code></p>
<p>GitHub关于此问题有<a
target="_blank" rel="noopener" href="https://github.com/huggingface/transformers/issues/19625#issuecomment-1296708659">讨论</a>。</p>
<p><code>transformers.models.t5.modeling_t5.T5Attention</code>有方法<code>prune_heads(heads_to_prune)</code>，接收一个List
<code>heads_to_prune</code>，内容为需要剪枝的head的index。使用后，这些heads将被直接移除，而不是mask成0。因此该方法能确实地缩小模型。</p>
<p>剪枝后，进行inference，有时会产生报错：<code>IndexError: index 2 is out of bounds for dimension 0 with size 2</code>。其中数字2可能为任意数字。</p>
<p>报错发生在<code>modeling_t5.py:554</code>。我在代码中加入了<code>try-except</code>以打印附近的问题：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> self<span class="token punctuation">.</span>pruned_heads<span class="token punctuation">:</span>
	mask <span class="token operator">=</span> torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>position_bias<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token keyword">try</span><span class="token punctuation">:</span>   <span class="token comment"># 新添加</span>
		mask<span class="token punctuation">[</span><span class="token builtin">list</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>pruned_heads<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>    <span class="token comment"># 报错行</span>
	<span class="token keyword">except</span> BaseException<span class="token punctuation">:</span>   <span class="token comment"># 新添加</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span>mask<span class="token punctuation">)</span>   <span class="token comment"># 新添加</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span>mask<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>   <span class="token comment"># 新添加</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>pruned_heads<span class="token punctuation">)</span>   <span class="token comment"># 新添加</span>
		<span class="token keyword">raise</span> BaseException<span class="token punctuation">(</span><span class="token string">"here"</span><span class="token punctuation">)</span>   <span class="token comment"># 新添加</span>
	position_bias_masked <span class="token operator">=</span> position_bias<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> mask<span class="token punctuation">.</span><span class="token builtin">bool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
	position_bias_masked <span class="token operator">=</span> position_bias<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>打印结果如下：</p>
<pre class="line-numbers language-none"><code class="language-none">...
tensor([0., 0.])
torch.Size([2])
&#123;0, 1, 2, 3, 5, 7&#125;
...
Traceback (most recent call last):
...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可见，<code>mask</code>的长度仅有2，也即index只能为0或1，因此读到<code>pruned_heads</code>的<code>2</code>后报错。但，该attention层应当有8个heads。回看代码，<code>mask</code>建立时长度与<code>position_bias</code>相同。因此，是<code>positional_bias</code>侧不能正确地处理包含剪枝的情况。</p>
<p><a
target="_blank" rel="noopener" href="https://github.com/huggingface/transformers/issues/19625#issuecomment-1296708659">原GitHub
Issue</a>的提出者发起了一个<a
target="_blank" rel="noopener" href="https://github.com/huggingface/transformers/pull/19975">Pull
Request</a>以处理此问题。解决方法为：在这段代码上方一点的地方，即<code>modeling_t5.py:536</code>，有下列代码：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">position_bias <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>
	<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>n_heads<span class="token punctuation">,</span> real_seq_length<span class="token punctuation">,</span> key_length<span class="token punctuation">)</span><span class="token punctuation">,</span> device<span class="token operator">=</span>scores<span class="token punctuation">.</span>device<span class="token punctuation">,</span> dtype<span class="token operator">=</span>scores<span class="token punctuation">.</span>dtype
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><code>torch.zeros()</code>的第一个元组中的第二个参数只计算了<code>self.n_heads</code>，即head数目。如果有剪枝，该数据无法对应上。将其增加<code>self.pruned_heads</code>的数目即可防止out
of bound错误。修改如下：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">position_bias <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>
	<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>n_heads <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>pruned_heads<span class="token punctuation">)</span><span class="token punctuation">,</span> real_seq_length<span class="token punctuation">,</span> key_length<span class="token punctuation">)</span><span class="token punctuation">,</span> device<span class="token operator">=</span>scores<span class="token punctuation">.</span>device<span class="token punctuation">,</span> dtype<span class="token operator">=</span>scores<span class="token punctuation">.</span>dtype
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>说实话我也不是很确定这是不是修好了，不过至少inference没有出问题。</p>

        </article>
        <section class="post-near">
            <ul>
                
                    <li>上一篇: <a href="/2023/08/16/Understanding%20Deep%20Learning%20Requires%20Rethinking%20Generalization/">Understanding Deep Learning Requires Rethinking Generalization</a></li>
                
                
                    <li>下一篇: <a href="/2023/06/14/%E3%80%8ADOOM%E3%80%8BMOD%E6%95%99%E7%A8%8B/">《DOOM》MOD教程</a></li>
                
            </ul>
        </section>
        
            <section class="post-tags">
            <a class="-none-link" href="/tags/Transformer/" rel="tag">Transformer</a><a class="-none-link" href="/tags/%E5%89%AA%E6%9E%9D/" rel="tag">剪枝</a><a class="-none-link" href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" rel="tag">机器学习</a>
            </section>
        
    
        <section class="post-author">
        
            <figure class="author-avatar">
                <img src="/images/favicon.png" alt="GreatSeal" />
            </figure>
        
            <div class="author-info">
                <h4>GreatSeal</h4>
                <p>来自佛得角的大海豹。</p>
            </div>
        </section>
    
    </div>
</main>

    <footer>
    <div class="buttons">
        <a class="to-top" href="#"></a>
    </div>
    <div class="wrap min">
        <section class="widget">
            <div class="row">
                <div class="col-m-4">
                    <h3 class="title-recent">最新文章：</h3>
                    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2023/08/16/Understanding%20Deep%20Learning%20Requires%20Rethinking%20Generalization/">Understanding Deep Learning Requires Rethinking Generalization</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/07/27/HuggingFace%20T5%E5%85%B3%E4%BA%8Eprune_heads%E6%96%B9%E6%B3%95%E7%9A%84bug/">HuggingFace T5关于prune_heads方法的bug</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/06/14/%E3%80%8ADOOM%E3%80%8BMOD%E6%95%99%E7%A8%8B/">《DOOM》MOD教程</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/03/22/%E4%BA%94%E7%AC%94%E6%89%93%E5%AD%97%E5%85%A5%E9%97%A8/">五笔打字入门</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/10/05/macos-shortcut-translate/">使用 MacOS 的「快捷指令」翻译论文中的选中段落</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/07/29/brainfuck/">用 Brainfuck 语言写 Hello World!</a></li></ul>
                </div>
                <div class="col-m-4">
                    <h3 class="title-date">时光机：</h3>
                    <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">August 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">July 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">June 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a></li></ul>
                </div>
                <div class="col-m-4">
                    <h3 class="title-tags">标签云：</h3>
                    <a href="/tags/Brainfuck/" style="font-size: 10px;">Brainfuck</a> <a href="/tags/DOOM/" style="font-size: 10px;">DOOM</a> <a href="/tags/MOD/" style="font-size: 10px;">MOD</a> <a href="/tags/MacOS/" style="font-size: 10px;">MacOS</a> <a href="/tags/Python/" style="font-size: 10px;">Python</a> <a href="/tags/Transformer/" style="font-size: 10px;">Transformer</a> <a href="/tags/%E4%BA%94%E7%AC%94/" style="font-size: 10px;">五笔</a> <a href="/tags/%E5%89%AA%E6%9E%9D/" style="font-size: 10px;">剪枝</a> <a href="/tags/%E5%B0%8F%E8%AF%B4/" style="font-size: 20px;">小说</a> <a href="/tags/%E6%95%B0%E5%AD%A6/" style="font-size: 10px;">数学</a> <a href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" style="font-size: 15px;">机器学习</a> <a href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%90%86%E8%AE%BA/" style="font-size: 10px;">机器学习理论</a> <a href="/tags/%E6%B3%9B%E5%8C%96/" style="font-size: 10px;">泛化</a> <a href="/tags/%E7%BC%96%E7%A8%8B/" style="font-size: 15px;">编程</a> <a href="/tags/%E7%BF%BB%E8%AF%91/" style="font-size: 10px;">翻译</a> <a href="/tags/%E8%AF%97%E6%AD%8C/" style="font-size: 10px;">诗歌</a> <a href="/tags/%E8%AF%BE%E5%A0%82%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">课堂笔记</a> <a href="/tags/%E8%BE%93%E5%85%A5%E6%B3%95/" style="font-size: 10px;">输入法</a> <a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 10px;">随笔</a>
                </div>
            </div>
        </section>
        <section class="sub-footer">
            <p>© 2023 <a href="/">佛得角大海豹的博客</a>. All Rights Reserved. Theme By <a href="https://github.com/Dreamer-Paul/Hingle" target="_blank" rel="nofollow">Hingle</a>.</p>
        </section>
    </div>
</footer>


<script src="/static/kico.js"></script>
<script src="/static/hingle.js"></script>


<script>var hingle = new Paul_Hingle({"copyright":false,"night":false});</script>

  </body>
</html>
